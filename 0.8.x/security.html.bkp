<!doctype html>
<html lang="en">
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-87598302-1"></script>
  <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-87598302-1');
</script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="assets/css/vendor.css" />
  <link rel="stylesheet" href="assets/css/style.css" />

  <title>BeAPI API Framework - Documentation / Security</title>
</head>
<body data-spy="scroll" data-target="#toc">


<section class="py-0">
  <div class="container-fluid">
    <div class="row justify-content-between">

      <!-- navigation -->
      <aside class="col-lg-3 col-xxl-2 p-3 doc-sidebar">
        <div class="sticky">
          <nav class="navbar navbar-vertical navbar-expand-lg navbar-light">
            <div>
              <a href="index.html" class="navbar-brand"><img src="assets/images/logo.png" alt="Logo"><span class="badge badge-green ml-2"></span></a>
              <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
            </div>


            <div class="collapse navbar-collapse" id="navbarSupportedContent">
              <ul id="page-nav" class="nav flex-column nav-vertical-2">
                <li class="nav-item">
                  <a class="nav-link" data-toggle="collapse" href="#menu-2" role="button" aria-expanded="false" aria-controls="menu-2">Installation</a>
                  <div class="collapse" id="menu-2" data-parent="#page-nav">
                    <div>
                      <ul class="nav flex-column">
                          <li class="nav-item">
                              <a class="nav-link" href="index.html#section-1">Requirements</a>
                          </li>
                          <li class="nav-item">
                              <a class="nav-link" href="index.html#section-2">Configure Demo Project</a>
                          </li>
                          <li class="nav-item">
                              <a class="nav-link" href="index.html#section-3">Setup Demo Project DB</a>
                          </li>
                          <li class="nav-item">
                              <a class="nav-link" href="index.html#section-4">Build Demo Project</a>
                          </li>
                          <li class="nav-item">
                              <a class="nav-link" href="index.html#section-5">Run Demo Project</a>
                          </li>
                          <li class="nav-item">
                              <a class="nav-link" href="index.html#section-6">Troubleshooting</a>
                          </li>
                      </ul>
                    </div>
                  </div>
                </li>
                  <li class="nav-item">
                      <a class="nav-link active" data-toggle="collapse" href="#menu-3" role="button" aria-expanded="false" aria-controls="menu-3">Configuration</a>
                      <div class="collapse" id="menu-3" data-parent="#page-nav">
                          <div>
                              <ul class="nav flex-column">
                                  <li class="nav-item">
                                      <a class="nav-link" href="config.html#section-1">Settings</a>
                                  </li>
                                  <li class="nav-item">
                                      <a class="nav-link" href="config.html#section-2">API Config</a>
                                  </li>
                              </ul>
                          </div>
                      </div>
                  </li>
                <li class="nav-item">
                  <a class="nav-link" data-toggle="collapse" href="#menu-5" role="button" aria-expanded="false" aria-controls="menu-5">Bootstrapping</a>
                  <div class="collapse" id="menu-5" data-parent="#page-nav">
                    <div>
                      <ul class="nav flex-column">
                        <li class="nav-item">
                          <a class="nav-link" href="bootstrap.html#section-1">Generate API Controllers</a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" href="bootstrap.html#section-2">Generate IO State</a>
                        </li>
                      </ul>
                    </div>
                  </div>
                </li>
                <li class="nav-item">
                  <a class="nav-link" data-toggle="collapse" href="#menu-4" role="button" aria-expanded="false" aria-controls="menu-4">Development</a>
                  <div class="collapse" id="menu-4" data-parent="#page-nav">
                    <div>
                      <ul class="nav flex-column">
                        <li class="nav-item">
                          <a class="nav-link" href="mvc.html#section-2">Controllers</a>
                        </li>
                          <li class="nav-item">
                              <a class="nav-link" href="mvc.html#section-3">IO State</a>
                          </li>
                      </ul>
                    </div>
                  </div>
                </li>
                <li class="nav-item">
                  <a class="nav-link active" data-toggle="collapse" href="#menu-6" role="button" aria-expanded="false" aria-controls="menu-6">Security</a>
                  <div class="collapse show" id="menu-6" data-parent="#page-nav">
                    <div>
                      <ul class="nav flex-column">
                        <li class="nav-item">
                          <a class="nav-link" href="security.html#section-1">CORS / NetworkGroups</a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" href="security.html#section-2">Roles / NetworkRoles</a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" href="security.html#section-3">SSO / Providers</a>
                        </li>
                      </ul>
                    </div>
                  </div>
                </li>
                <li class="nav-item">
                  <a class="nav-link" data-toggle="collapse" href="#menu-7" role="button" aria-expanded="false" aria-controls="menu-7">API Usage (Examples)</a>
                  <div class="collapse" id="menu-7" data-parent="#page-nav">
                    <div>
                      <ul class="nav flex-column">
                        <li class="nav-item">
                          <a class="nav-link" href="usage.html#section-1">Authorization Calls</a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" href="usage.html#section-2">API Calls</a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" href="usage.html#section-3">User Management</a>
                        </li>
                      </ul>
                    </div>
                  </div>
                </li>
                <li class="nav-item">
                  <a class="nav-link" data-toggle="collapse" href="#menu-8" role="button" aria-expanded="false" aria-controls="menu-8">Advanced Functionality</a>
                  <div class="collapse" id="menu-8" data-parent="#page-nav">
                    <div>
                      <ul class="nav flex-column">
                        <li class="nav-item">
                          <a class="nav-link" href="advanced.html#section-1">Automated Batching</a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" href="advanced.html#section-2">Automated Webhooks</a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" href="advanced.html#section-3">API ChainingÂ®</a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" href="advanced.html#section-4">Architecture PING</a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" href="advanced.html#section-5">Rate Limiting</a>
                        </li>
                      </ul>
                    </div>
                  </div>
                </li>
                <li class="nav-item">
                  <a class="nav-link" data-toggle="collapse" href="#menu-9" role="button" aria-expanded="false" aria-controls="menu-9">Advanced Configuration</a>
                  <div class="collapse" id="menu-9" data-parent="#page-nav">
                    <div>
                      <ul class="nav flex-column">
                        <li class="nav-item">
                          <a class="nav-link" href="adv_config.html#section-1">Versioning</a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" href="adv_config.html#section-2">IO State</a>
                        </li>
                      </ul>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
          </nav>
        </div>
      </aside>
      <!-- / navigation -->


      <!-- content -->
      <article class="col-lg-9 col-xxl-10 doc-content">

        <div class="row">
          <div class="col">
            <div class="doc-content-header">
              <div class="row align-items-center">
                <div class="col">
                  <nav aria-label="breadcrumb" class="align-items-center">
                    <ol class="breadcrumb d-none d-lg-inline-flex">
                      <li class="breadcrumb-item"><a href="index.html">Documentation</a></li>
                      <li class="breadcrumb-item active" aria-current="page">Security</li>
                    </ol>
                  </nav>
                </div>
                <div class="col text-right">

                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row justify-content-between doc-content-body">
          <article class="col-md-9 col-xxl-8">

            <h1 class="h2 font-weight-light"><b>Security</b></h1>
            <p>When adding security to your endpoints, there are two levels that we take into consideration: CORS for securing application access and an OAUTH implementation that uses ROLES for securing user access. Below we will go over how you can better configure these two in your implementation.</p>

<hr size="5">

            <!-- typogrpahy -->
            <section id="section-1">
              <h2 class="section-title-2">CORS / NetworkGroups<a data-scroll href="#section-1" class="anchor" data-toggle="tooltip" data-placement="top" title="Copy URL"><i class="icon-hash"></i></a></h2>
              <p>At the top of your <b>'~/.beapi/beapi_api.yml'</b> config file, you will see a group of lines that look like this:</p>
              <div class="row">
                <div class="col">
                  <div class="card">
                    <div class="card-body" style="background-color:#000;">
                      <pre style="background-color:#000;padding:0px;margin:0px;"><code class="language-sh">apitoolkit:
    apiName: api
    attempts: 5
    procCores: 8
    networkGroups: ['private','public']
    ...</code></pre>
                    </div>
                  </div>
                </div>
              </div>
              <p>Right now we are only interested in <b>networkGroups</b>. The 'networkGroups' defines 'allowedOrigins' groups for CORS (Cross Origin Resource Sharing) which we can then associate with each group of endpoints in our IO state files. We associate the 'allowedOrigins' further down in the 'beapi_api.yml' file under corsInterceptor:</p>
              <div class="row">
                <div class="col">
                  <div class="card">
                    <div class="card-body" style="background-color:#000;">
                      <pre style="background-color:#000;padding:0px;margin:0px;"><code class="language-sh">    corsInterceptor:
        includeEnvironments: ['development','test','production']
        excludeEnvironments: []
        networkGroups:
            public: ['http://localhost','http://localhost:8080','http://127.0.0.1','http://test.nosegrind.net']
            private: ['http://localhost','http://localhost:8080','http://127.0.0.1']
    ...</code></pre>
                    </div>
                  </div>
                </div>
              </div>
              <p>Once we have the Network groups <b>named</b> and <b>defined</b>, we can then assign them in our IO State. Below is the top of our 'Person' IO State file as an example of how we do the assignment:</p>
              <div class="row">
                <div class="col">
                  <div class="card">
                    <div class="card-body" style="background-color:#000;">
                      <pre style="background-color:#000;padding:0px;margin:0px;"><code class="language-sh">{
    "NAME":"person",
    "NETWORKGRP": "public",
    "VALUES": {
        ...</code></pre>
                    </div>
                  </div>
                </div>
              </div>
              <p>You can see <a href="https://github.com/orubel/beapi_backend/tree/master/src/iostate">an example of this</a> at the top of anyone of the pregenerated IO State files in your project.</p>
              <p>As you can see, we use the 'public' networkGrp so it upon lookup of the endpoint, we immediately know which 'allowedOrigins' to use. Others might use 'private so that we can use INTERNAL networks rather than EXTERNAL networks. This makes it easier for us to use one backend for internal and external endpoints.</p>
            </section>
            <!-- / typography -->

<hr size="5">


            <!-- file tree -->
            <section id="section-2">
              <h2 class="section-title-2">Roles / NetworkRoles<a data-scroll href="#section-2" class="anchor" data-toggle="tooltip" data-placement="top" title="Copy URL"><i class="icon-hash"></i></a></h2>
              <p>The <b>'networkRoles'</b> are very similar to 'networkGroups' in that you are assigning ROLES to your 'networkGroups' as a set of ROLES to be pulled from for assignment:</p>
              <div class="row">
                <div class="col">
                  <div class="card">
                    <div class="card-body" style="background-color:#000;">

                        <pre style="background-color:#000;padding:0px;margin:0px;"><code class="language-sh">apitoolkit:
    apiName: api
    attempts: 5
    procCores: 8
    networkGroups: ['private','public']
    networkRoles:
        public: ['ROLE_USER','ROLE_ADMIN']
        private: ['ROLE_ADMIN']</code></pre>

                    </div>
                  </div>
                </div>
              </div>
                  <br/>
              <p>So above in 'public', those are the ok'd roles to use for making API calls and they will be checked against all incoming calls using 'public'</p>
            <p>So if your IO State is declared as public, you will want your users to have ROLES listed in networkRoles.public. Pretty easy!</p>
            </section>
            <!-- / file tree -->

<hr size="5">

            <!-- file tree -->
            <section id="section-3">
              <h2 class="section-title-2">Single Sign-on & Providers<a data-scroll href="#section-3" class="anchor" data-toggle="tooltip" data-placement="top" title="Copy URL"><i class="icon-hash"></i></a></h2>
              <p>We are quickly trying to implement as many providers as we can into a signle sign-on for your service and if you don't see one you want, you can always donate to the project to speed up the process.</p>
              <div class="row">
                <div class="col">
                  <div class="card" role="alert">
                    <div class="card-body">

                        <ul>
                          <li><p><b>Google</b> - Use the following link to integrate a Google Sign-in into your frontend (remember to add your frontend FQDNS/IP to your <a href="#section-1">CORS config</a>).</p>
                            <p>Next, follow all Google instructions except use the following code instead pointing to <b>'yourdomain:8080/provider/auth/google'</b>:
                              <pre style="background-color:#000;padding:0px;margin:0px;"><code class="language-sh">
<script>
      var clicked=false;
      function ClickLogin(){
          clicked=true;
      }
      function onSignIn(googleUser) {
        if (clicked) {
            console.log('google signing in');
            // Useful data for your client-side scripts:
            var profile = googleUser.getBasicProfile();

            var fname = profile.getGivenName();
            var lname = profile.getFamilyName();
            var avatarUrl = profile.getImageUrl();
            var email = profile.getEmail();

            // The ID token you need to pass to your backend:
            var id_token = googleUser.getAuthResponse().id_token;
            console.log("ID Token: " + id_token);

            var jsonData = {"fname":fname,"lname":lname,"avatarUrl":avatarUrl,"email":email};
            console.log(jsonData);

            $.ajax({
                type: 'POST',
                url: "http://" + window.location.hostname + ":8080/provider/auth/google",
                cache:false,
                async:true,
                contentType: 'application/json',
                data: JSON.stringify(jsonData),
                //dataType:'json',
                headers: {
                    'Access-Control-Allow-Origin': '*'
                },
                xhrFields:{
                    withCredentials: true
                },
                crossDomain: true,
        	    error: function (xhr, textStatus, thrownError){
            	    console.log('error: ' + xhr.responseText);
        	    },
        	    success: function (data, textStatus, xhr){
			        console.log('success');
        	    },
        	    complete: function (xhr, textStatus) {
                    console.log('complete');
        	    }
            }).done(function(data, textStatus, jqXHR) {
		        console.log('done')
                var obj = JSON.parse(jqXHR.responseText);
                localStorage.setItem('beapi_token', JSON.stringify(obj));

                var body = "common/login.html"
                if(localStorage.getItem('beapi_token')!=null){
                    var test = localStorage.getItem('beapi_token');
                    var json = JSON.parse(test)
                    var test2 = $.inArray('ROLE_ADMIN',json.authorities)
                    var test3 = $.inArray('ROLE_USER',json.authorities)
                    if(test2>=0 || test3>=0){
                        body = "common/default.html"
                    }
                }

                $("#page-top").load(body);
                location.reload();
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.log('fail'+textStatus);
                var msg = '';
                if (jqXHR.status === 0) {
                    msg = 'Not connected.Verify Network.'+window.url+'.Error:'+errorThrown;
                } else if (jqXHR.status == 404) {
                    msg = 'Requested page not found. [404]\n' + jqXHR.responseText;
                } else if (jqXHR.status == 500) {
                    msg = 'Internal Server Error [500].\n' + jqXHR.responseText;
                } else if (exception === 'parsererror') {
                    msg = 'Bad Credentials. Please Try Again';
                } else if (exception === 'timeout') {
                    msg = 'Time out error.';
                } else if (exception === 'abort') {
                    msg = 'Ajax request aborted.';
                } else {
                    msg = 'Uncaught Error.\n' + jqXHR.responseText;
                }
                alert(msg);
            })
        }
      }
</script>
<script>
  function signOut() {
    var auth2 = gapi.auth2.getAuthInstance();
    auth2.signOut().then(function () {
      console.log('User signed out.');
    });
  }
</script>
                              </code></pre>
                            </p>
                            <p>Now the following will install the Google Button on your page:
                            <pre style="background-color:#000;padding:0px;margin:0px;"><code class="language-sh">
&lt;div class="g-signin2" data-onsuccess="onSignIn" onclick="ClickLogin()"&gt;&lt;/div&gt;
                            </code></pre>
                            </p>
                            <p>See the following Google page for <a href="https://developers.google.com/identity/sign-in/web/build-button">customizing your Google button</a>.</p>
                          </li>
                        </ul>


                  </div>
                </div>
              </div>
            </section>
            <!-- / file tree -->


<hr size="5">

            <!-- file tree -->
            <section id="section-4">
              <h2 class="section-title-2">Troubleshooting<a data-scroll href="#section-4" class="anchor" data-toggle="tooltip" data-placement="top" title="Copy URL"><i class="icon-hash"></i></a></h2>
              <p></p>
              <div class="row">
                <div class="col">
                  <div class="alert alert-warning" role="alert">
                    <ul>
                      <li>Your endpoint can only use the ROLES defined for it's 'networkGroup'; if you want a different set of roles, define a different 'networkGroup'</li>
                      <li>If you are unable to access the backend from your frontend application, make sure you have added it to your acceptable URL's under 'corsInterceptor.networkGroups' in your <b>'~/.beapi/beapi_api.yml'</b> config file</li>
                    </ul>
                  </div>
                </div>
              </div>
            </section>
            <!-- / file tree -->

          </article>


          <aside class="col-md-3 col-xxl-3 d-none d-md-block">
            <div class="sticky">
              <ul id="toc" class="nav flex-column toc">
                <li class="nav-item">
                  <a data-scroll class="nav-link" href="#section-1">CORS / NetworkGroups</a>
                </li>
                <li class="nav-item">
                  <a data-scroll class="nav-link" href="#section-2">Roles / NetworkRoles</a>
                </li>
                <li class="nav-item">
                  <a data-scroll class="nav-link" href="#section-3">SSO / Providers</a>
                </li>
                <li class="nav-item">
                  <a data-scroll class="nav-link" href="#section-4">Troubleshooting</a>
                </li>
              </ul>
            </div>
          </aside>


        </div>

      </article>
      <!-- / content -->

    </div>
  </div>
</section>


<!-- footer -->
<footer class="bg-dark">
  <div class="container">
    <div class="row gutter-3">
      <div class="col-12 col-md-2">
        <a href=""><img src="assets/images/logo_bw.png" alt="Logo"></a>
      </div>
      <div class="col-12 col-md-6 text-white">
        <p class="mb-4">Copyright Â© 2014-2019 - All Rights Reserved</p></div>
      <div class="col-12 col-md-4 col-lg-2 ml-auto text-md-right">
        <div class="dropdown"> </div>
      </div>
    </div>
  </div>
</footer>
<!-- / footer -->


<script src="assets/js/vendor.min.js"></script>
<script src="assets/js/app.js"></script>
</body>
</html>